<template>
    <div>
      <div v-if="state === 'redirect'">
        <Lottie :height="256" :style="style" name="Wave" />
  
        <div class="text-center">
          <n-h1>使用LoCyanFrp账号登录联合映射</n-h1>
  
          <n-button class="text-center" type="info" @click="toLogin">
            现在登录！
          </n-button>
        </div>
  
      </div>
      <div v-else-if="state === 'logging'">
        <Lottie :height="256" :name="logo" :style="style" />
      </div>
      <div v-else-if="state === 'error'">
        <Lottie :height="256" :style="style" name="Ghost" />
  
        <div class="text-center">
          <n-h1 class="mt-5">
            <n-text class="text-center" type="error">
              你的 Token 无效
            </n-text>
          </n-h1>
  
          <n-button type="error" @click="toLogin">
            重新登录
          </n-button>
        </div>
      </div>
  
      <p v-show="state === 'logging'" class="text-center mt-5">
        <span>莱云的 Logo 动画由 Fofray 制作。</span>
      </p>
  
      <p v-if="state === 'redirect'" class="text-center mt-5">
      联合映射
      <br />
      由 LoCyan Team & MirrorEdge Network 联合运营
      <br />
    </p>
  
    </div>
  </template>
  
  <script setup>
  import { ref } from 'vue'
  import { NButton, NH1, NText } from 'naive-ui'
  import http from '../../plugins/http'
  import router from '../../plugins/router'
  import api from '../../config/api'
  import user from "../../plugins/stores/user.js";
  import Lottie from "../../components/Lottie.vue";
  
  
  const style = {
    textAlign: 'center',
    marginTop: '20px',
    marginBottom: '20px'
  }
  
  const origin = "https://oauth.locyanfrp.cn/login"
  
  console.log('auth server: ' + origin)
  
  const token = ref('')
  const state = ref('redirect')
  
  const connect = () => {
    state.value = 'logging'
  
    user.commit('updateToken', token.value)
  
    http
      .get('/user')
      .then((res) => {
        setTimeout(() => {
          user.commit('updateToken', token.value)
          user.commit('updateUser', res.data)
  
          router.push('/')
          location.href = '/'
        }, 1000)
  
      })
      .catch(() => {
        state.value = 'error'
  
        user.commit('updateToken', '')
        user.commit('updateUser', {})
      })
  
  }
  
  const query = router.currentRoute.value.query
  
  if (query.token != null) {
    token.value = query.token
    connect()
  }
  
  // else {
  //   setTimeout(toLogin, 1000)
  // }
  
  function toLogin() {
  
    // protocol + domain + pathname
    const redirect = location.origin + location.pathname
    window.location.href = origin + '?callback=' + encodeURIComponent(redirect)
  }
  
  const logo = ref('Logo-dark')
  if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    logo.value = 'Logo-white'
  }
  </script>